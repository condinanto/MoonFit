# MOON FIT Telegram Bot - Architecture Overview

## Overview

MOON FIT is a comprehensive Telegram e-commerce bot for a fashion store specializing in T-shirts, hoodies, and hats. The system integrates TON cryptocurrency payments, comprehensive admin management, discount codes, product reviews, and shopping cart functionality. Built using Python with the python-telegram-bot library, it features a modular architecture with SQLite database storage.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Core Architecture Pattern
The application follows a modular monolithic architecture with clear separation of concerns:

- **Main Application Layer**: Handles Telegram bot interactions and conversation flows
- **Business Logic Layer**: Separate managers for products, cart, discounts, reviews, and payments
- **Data Access Layer**: Centralized database operations through a Database class
- **Configuration Layer**: Environment-based configuration management

### Technology Stack
- **Framework**: Python with python-telegram-bot library
- **Database**: SQLite with custom ORM-like wrapper
- **Payment Integration**: TON blockchain API
- **Deployment**: Replit-compatible structure
- **Logging**: Python's built-in logging module

## Key Components

### 1. Bot Core (`main.py`)
- **Purpose**: Main application entry point and conversation handler
- **Architecture Decision**: Uses ConversationHandler for multi-step user interactions
- **Rationale**: Provides stateful conversations for complex operations like product creation and review submission

### 2. Database Management (`database.py`)
- **Purpose**: Centralized data access layer with SQLite
- **Architecture Decision**: Custom database wrapper with row factory for dict-like access
- **Schema**: Users, products, orders, reviews, discount codes, admin logs, and payment tracking
- **Rationale**: SQLite chosen for simplicity and Replit compatibility

### 3. Product Management (`product_manager.py`)
- **Purpose**: Handles product CRUD operations and inventory management
- **Features**: Stock tracking, category management (T-shirts, hoodies, hats), price validation
- **Architecture Decision**: Static methods for stateless operations
- **Rationale**: Product operations don't require instance state

### 4. Shopping Cart (`cart_manager.py`)
- **Purpose**: Manages user shopping carts with session persistence
- **Architecture Decision**: JSON storage in database for cart data
- **Features**: Stock validation, quantity management, price calculations
- **Rationale**: Simple JSON storage avoids complex cart table relationships

### 5. Payment Processing (`ton_payments.py`)
- **Purpose**: Handles TON cryptocurrency payments and transaction verification
- **Architecture Decision**: Async HTTP client for blockchain API calls
- **Features**: Transaction monitoring, payment timeouts, testnet support
- **Rationale**: Async operations prevent blocking during payment verification

### 6. Admin Panel (`admin_panel.py`)
- **Purpose**: Administrative dashboard and management functions
- **Features**: Sales analytics, order management, user statistics
- **Architecture Decision**: Role-based access control with single admin ID
- **Rationale**: Simple admin system suitable for small business operations

### 7. Discount System (`discount_manager.py`)
- **Purpose**: Creates and manages promotional discount codes
- **Features**: Percentage and fixed amount discounts, usage limits, expiry dates
- **Architecture Decision**: Code-based discount system with usage tracking
- **Rationale**: Flexible promotional tool with built-in fraud prevention

### 8. Review System (`review_manager.py`)
- **Purpose**: Manages customer product reviews and ratings
- **Features**: 5-star rating system, comment moderation, user verification
- **Architecture Decision**: Admin approval workflow for review publication
- **Rationale**: Ensures review quality and prevents spam

## Data Flow

### 1. User Interaction Flow
```
User Input → Main Bot Handler → Business Logic Manager → Database Layer → Response
```

### 2. Purchase Flow
```
Product Selection → Cart Management → Discount Application → TON Payment → Order Processing → Confirmation
```

### 3. Admin Operations Flow
```
Admin Authentication → Admin Panel → Management Operations → Database Updates → Logging
```

### 4. Payment Verification Flow
```
Payment Initiation → TON API Monitoring → Transaction Verification → Order Status Update → User Notification
```

## External Dependencies

### 1. Telegram Bot API
- **Purpose**: Core bot functionality and user interface
- **Integration**: python-telegram-bot library with webhook support
- **Rationale**: Official library provides robust Telegram integration

### 2. TON Blockchain API
- **Purpose**: Cryptocurrency payment processing
- **Integration**: REST API calls to TON Center
- **Features**: Transaction monitoring, wallet balance checking
- **Rationale**: Direct blockchain integration ensures payment security

### 3. Environment Variables
- **Configuration**: Bot tokens, admin IDs, wallet addresses
- **Security**: Sensitive data stored in environment variables
- **Rationale**: Prevents hardcoded secrets in source code

## Deployment Strategy

### 1. Replit Compatibility
- **Architecture Decision**: Single-file structure with minimal external dependencies
- **Database**: SQLite file-based storage for Replit persistence
- **Configuration**: Environment variable support for Replit secrets

### 2. Modular Design Benefits
- **Maintainability**: Clear separation allows independent module updates
- **Testing**: Individual components can be tested in isolation
- **Scalability**: Easy to extract modules into microservices if needed

### 3. Error Handling and Logging
- **Strategy**: Comprehensive logging throughout all modules
- **Error Recovery**: Graceful error handling with user-friendly messages
- **Admin Notifications**: Critical errors reported to admin users

### 4. Data Persistence
- **Architecture Decision**: SQLite with JSON fields for flexible data storage
- **Backup Strategy**: File-based database allows easy backup and migration
- **Rationale**: Simple deployment without external database dependencies

## Development Considerations

### 1. Conversation State Management
- **Challenge**: Managing multi-step user interactions
- **Solution**: ConversationHandler with defined states
- **Benefits**: Clean state transitions and user experience

### 2. Payment Security
- **Challenge**: Ensuring secure cryptocurrency transactions
- **Solution**: Transaction verification through blockchain API
- **Benefits**: Cryptographic security without storing sensitive payment data

### 3. Admin Scalability
- **Current**: Single admin ID configuration
- **Future**: Extensible to role-based admin system
- **Rationale**: Simple initial implementation with growth path

This architecture provides a solid foundation for a Telegram e-commerce bot with cryptocurrency payments, designed for easy deployment and maintenance while supporting business growth.